version: '3.9'

secrets:
  api_env:
    file: ./secrets/api.env
  postgres_password:
    file: ./secrets/postgres_password
  redis_password:
    file: ./secrets/redis_password

services:
  api:
    secrets:
      - api_env
    environment:
      DATABASE_URL_FILE: /run/secrets/api_env
    depends_on:
      - vault

  postgres:
    secrets:
      - postgres_password
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password

  redis:
    secrets:
      - redis_password
    command: redis-server --appendonly yes --requirepass $(cat /run/secrets/redis_password)

  vault:
    image: hashicorp/vault:1.15
    container_name: kitium-vault
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=kitium-root-token
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    command: vault server -dev -dev-root-token-id=kitium-root-token
    networks:
      - kitium-network

networks:
  kitium-network:
    external: true
